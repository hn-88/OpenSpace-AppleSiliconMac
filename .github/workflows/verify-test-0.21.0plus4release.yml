name: 0.21.0plus4 Test OpenSpace macOS PKG Installer

on:
  workflow_dispatch:

jobs:
  install-and-test:
    runs-on: macos-14

    steps:
      - name: Create logs directory
        run: mkdir -p logs

      - name: Download OpenSpace PKG
        run: |
          curl -L -o OpenSpace.pkg \
            https://github.com/hn-88/OpenSpace-AppleSiliconMac/releases/download/v0.21.0plus4/OpenSpace-0.21.0plus4-minimal.pkg

      - name: Remove quarantine attribute from PKG
        run: |
          xattr -rd com.apple.quarantine OpenSpace.pkg || echo "No quarantine flag on pkg"

      - name: Install OpenSpace.pkg
        run: |
          sudo installer -pkg OpenSpace.pkg -target / | tee logs/install.log

      - name: Remove quarantine from installed files
        run: |
          if [ -d "$HOME/OpenSpace" ]; then
            echo "‚úÖ Found installation directory"
            xattr -r -d com.apple.quarantine "$HOME/OpenSpace/bin/OpenSpace.app" || echo "No quarantine flag found on installed files"
          else
            echo "‚ùå Installation directory not found"
            exit 1
          fi

      - name: Verify .app bundle
        run: |
          if [ -d "$HOME/OpenSpace/bin/OpenSpace.app" ]; then
            echo "‚úÖ Found OpenSpace.app"
          else
            echo "‚ùå OpenSpace.app not found at expected location"
            exit 1
          fi

      - name: Check Applications Shortcut
        run: |
          SHORTCUT="/Applications/OpenSpace"
          TARGET="$HOME/OpenSpace/bin/OpenSpace.app"
          if [ -L "$SHORTCUT" ]; then
            LINK_TARGET=$(readlink "$SHORTCUT")
            echo "üîó Shortcut found: $SHORTCUT ‚Üí $LINK_TARGET"
            if [ "$LINK_TARGET" = "$TARGET" ]; then
              echo "‚úÖ Shortcut points to correct target"
            else
              echo "‚ö†Ô∏è Shortcut exists but points to wrong target"
              exit 1
            fi
          else
            echo "‚ùå No shortcut found at $SHORTCUT"
            exit 1
          fi

      - name: Launch OpenSpace (simulate)
        run: |
          EXEC="$HOME/OpenSpace/bin/OpenSpace.app/Contents/MacOS/OpenSpace"
          if [ ! -x "$EXEC" ]; then
            echo "‚ùå Executable not found inside .app bundle"
            exit 1
          fi
          echo "‚úÖ Found executable, attempting to launch..."
          "$EXEC" --version > logs/launch_output.log 2>&1 || echo "‚ö†Ô∏è Launch attempted (nonzero exit code allowed)"

      - name: Upload logs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openspace-install-logs
          path: logs/
